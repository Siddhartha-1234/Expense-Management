<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .sidebar-link.active {
            background-color: #e5e7eb;
            color: #111827;
            font-weight: 600;
        }
    </style>
</head>
<body class="antialiased">
    <div id="app"></div>

    <script>
        const app = document.getElementById('app');

        // --- MOCK DATABASE (using localStorage) ---
        const db = {
            users: JSON.parse(localStorage.getItem('users')) || [],
            companies: JSON.parse(localStorage.getItem('companies')) || [],
            expenses: JSON.parse(localStorage.getItem('expenses')) || [],
            currentUser: JSON.parse(localStorage.getItem('currentUser')) || null,

            save() {
                localStorage.setItem('users', JSON.stringify(this.users));
                localStorage.setItem('companies', JSON.stringify(this.companies));
                localStorage.setItem('expenses', JSON.stringify(this.expenses));
                localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
            }
        };

        // --- ROUTER ---
        const router = () => {
            const path = window.location.hash.slice(1) || '/';
            const [route, param] = path.split('/');

            if (!db.currentUser) {
                if (route === 'signup') {
                    renderSignupPage();
                } else {
                    renderLoginPage();
                }
                return;
            }

            switch (db.currentUser.role) {
                case 'Admin':
                    renderAdminDashboard(route, param);
                    break;
                case 'Manager':
                    renderManagerDashboard(route, param);
                    break;
                case 'Employee':
                    renderEmployeeDashboard(route, param);
                    break;
                default:
                    renderLoginPage();
            }
        };
        
        // --- AUTHENTICATION ---
        const handleLogin = (email, password) => {
            const user = db.users.find(u => u.email === email && u.password === password);
            if (user) {
                db.currentUser = user;
                db.save();
                window.location.hash = '/dashboard';
                router();
            } else {
                alert('Invalid email or password');
            }
        };

        const handleSignup = async (companyName, country, email, password) => {
            if (db.users.some(u => u.email === email)) {
                alert('User with this email already exists.');
                return;
            }

            try {
                const response = await fetch(`https://restcountries.com/v3.1/name/${country}?fullText=true`);
                if (!response.ok) throw new Error('Country not found');
                const data = await response.json();
                const currency = Object.keys(data[0].currencies)[0];

                const companyId = 'comp_' + Date.now();
                const newCompany = { id: companyId, name: companyName, currency };
                db.companies.push(newCompany);

                const adminUser = {
                    id: 'user_' + Date.now(),
                    email,
                    password,
                    role: 'Admin',
                    companyId: companyId,
                    managerId: null,
                    name: 'Admin User'
                };
                db.users.push(adminUser);
                db.currentUser = adminUser;
                db.save();

                window.location.hash = '/dashboard';
                router();
            } catch (error) {
                console.error('Signup error:', error);
                alert('Failed to sign up. Please check the country name and try again.');
            }
        };
        
        const handleLogout = () => {
            db.currentUser = null;
            db.save();
            window.location.hash = '/login';
            router();
        };

        // --- VIEWS / PAGES ---
        const renderLoginPage = () => {
            app.innerHTML = `
                <div class="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
                    <div class="max-w-md w-full space-y-8">
                        <div>
                            <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">Sign in to your account</h2>
                        </div>
                        <form id="login-form" class="mt-8 space-y-6">
                            <input type="hidden" name="remember" value="true">
                            <div class="rounded-md shadow-sm -space-y-px">
                                <div>
                                    <label for="email-address" class="sr-only">Email address</label>
                                    <input id="email-address" name="email" type="email" autocomplete="email" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="Email address">
                                </div>
                                <div>
                                    <label for="password" class="sr-only">Password</label>
                                    <input id="password" name="password" type="password" autocomplete="current-password" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="Password">
                                </div>
                            </div>
                            <div>
                                <button type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                    Sign in
                                </button>
                            </div>
                        </form>
                         <div class="text-sm text-center">
                            <a href="#signup" class="font-medium text-indigo-600 hover:text-indigo-500">
                                Don't have an account? Sign up
                            </a>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('login-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const email = e.target.email.value;
                const password = e.target.password.value;
                handleLogin(email, password);
            });
        };

        const renderSignupPage = () => {
            app.innerHTML = `
                <div class="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
                    <div class="max-w-md w-full space-y-8">
                        <div>
                            <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">Create a new account</h2>
                        </div>
                        <form id="signup-form" class="mt-8 space-y-6">
                            <div class="rounded-md shadow-sm space-y-4">
                                <input name="companyName" type="text" required class="appearance-none rounded-md relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Company Name">
                                <input name="country" type="text" required class="appearance-none rounded-md relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Country (e.g., India)">
                                <input name="email" type="email" autocomplete="email" required class="appearance-none rounded-md relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Email address">
                                <input name="password" type="password" autocomplete="new-password" required class="appearance-none rounded-md relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Password">
                            </div>
                            <div>
                                <button type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                    Sign up
                                </button>
                            </div>
                        </form>
                         <div class="text-sm text-center">
                            <a href="#login" class="font-medium text-indigo-600 hover:text-indigo-500">
                                Already have an account? Sign in
                            </a>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('signup-form').addEventListener('submit', e => {
                e.preventDefault();
                const companyName = e.target.companyName.value;
                const country = e.target.country.value;
                const email = e.target.email.value;
                const password = e.target.password.value;
                handleSignup(companyName, country, email, password);
            });
        };
        
        const renderLayout = (sidebarLinks, content) => {
            const company = db.companies.find(c => c.id === db.currentUser.companyId);
            return `
                <div class="flex h-screen bg-gray-100">
                    <!-- Sidebar -->
                    <div class="w-64 bg-white shadow-md">
                        <div class="p-4 border-b">
                            <h1 class="text-xl font-bold text-gray-800">${company.name}</h1>
                            <p class="text-sm text-gray-500">${db.currentUser.role}</p>
                        </div>
                        <nav class="mt-4">
                            ${sidebarLinks}
                        </nav>
                        <div class="absolute bottom-0 w-64 p-4 border-t">
                            <p class="text-sm font-medium text-gray-800">${db.currentUser.name || db.currentUser.email}</p>
                            <button id="logout-btn" class="w-full mt-2 text-left text-sm text-red-600 hover:text-red-800">Logout</button>
                        </div>
                    </div>

                    <!-- Main Content -->
                    <div class="flex-1 flex flex-col overflow-hidden">
                        <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-200">
                            <div class="container mx-auto px-6 py-8">
                                ${content}
                            </div>
                        </main>
                    </div>
                </div>
            `;
        };
        
        // --- ADMIN DASHBOARD ---
        const renderAdminDashboard = (route, param) => {
            const sidebarLinks = `
                <a href="#dashboard" class="sidebar-link ${route === 'dashboard' ? 'active' : ''} flex items-center px-4 py-2 text-gray-700 hover:bg-gray-200">
                    <i data-lucide="layout-dashboard" class="w-5 h-5 mr-2"></i> Dashboard
                </a>
                <a href="#users" class="sidebar-link ${route === 'users' ? 'active' : ''} flex items-center px-4 py-2 text-gray-700 hover:bg-gray-200">
                    <i data-lucide="users" class="w-5 h-5 mr-2"></i> Manage Users
                </a>
                <a href="#expenses" class="sidebar-link ${route === 'expenses' ? 'active' : ''} flex items-center px-4 py-2 text-gray-700 hover:bg-gray-200">
                   <i data-lucide="receipt" class="w-5 h-5 mr-2"></i> All Expenses
                </a>
                 <a href="#approval-rules" class="sidebar-link ${route === 'approval-rules' ? 'active' : ''} flex items-center px-4 py-2 text-gray-700 hover:bg-gray-200">
                   <i data-lucide="git-pull-request-arrow" class="w-5 h-5 mr-2"></i> Approval Rules
                </a>
            `;
            
            let content = '';
            switch(route) {
                case 'dashboard': content = getAdminDashboardContent(); break;
                case 'users': content = getAdminUsersContent(); break;
                case 'expenses': content = getAllExpensesContent('Admin'); break;
                case 'approval-rules': content = getApprovalRulesContent(); break;
                default: content = getAdminDashboardContent();
            }

            app.innerHTML = renderLayout(sidebarLinks, content);
            lucide.createIcons();
            addAdminEventListeners();
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
        };
        
        const getAdminDashboardContent = () => {
             const companyExpenses = db.expenses.filter(e => {
                const user = db.users.find(u => u.id === e.userId);
                return user && user.companyId === db.currentUser.companyId;
            });
            const pending = companyExpenses.filter(e => e.status === 'Pending').length;
            const approved = companyExpenses.filter(e => e.status === 'Approved').length;
            const rejected = companyExpenses.filter(e => e.status === 'Rejected').length;
            const total = companyExpenses.reduce((sum, e) => sum + e.amount, 0);
            const company = db.companies.find(c => c.id === db.currentUser.companyId);

            return `
                <h3 class="text-3xl font-medium text-gray-700">Admin Dashboard</h3>
                <div class="mt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h4 class="text-gray-600 text-sm font-medium">Total Expenses</h4>
                        <p class="text-3xl font-bold text-gray-800">${total.toFixed(2)} ${company.currency}</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h4 class="text-gray-600 text-sm font-medium">Pending Approval</h4>
                        <p class="text-3xl font-bold text-yellow-500">${pending}</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h4 class="text-gray-600 text-sm font-medium">Approved</h4>
                        <p class="text-3xl font-bold text-green-500">${approved}</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h4 class="text-gray-600 text-sm font-medium">Rejected</h4>
                        <p class="text-3xl font-bold text-red-500">${rejected}</p>
                    </div>
                </div>
            `;
        };

        const getAdminUsersContent = () => {
            const companyUsers = db.users.filter(u => u.companyId === db.currentUser.companyId);
            const managers = companyUsers.filter(u => u.role === 'Manager' || u.role === 'Admin');

            return `
                <div class="flex justify-between items-center">
                    <h3 class="text-3xl font-medium text-gray-700">Manage Users</h3>
                    <button id="add-user-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Add User</button>
                </div>

                <!-- Add user modal -->
                <div id="add-user-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
                    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Add New User</h3>
                        <form id="add-user-form">
                           <input name="name" type="text" required class="w-full p-2 mb-4 border rounded" placeholder="Full Name">
                           <input name="email" type="email" required class="w-full p-2 mb-4 border rounded" placeholder="Email">
                           <input name="password" type="password" required class="w-full p-2 mb-4 border rounded" placeholder="Password">
                           <select name="role" required class="w-full p-2 mb-4 border rounded">
                                <option value="Employee">Employee</option>
                                <option value="Manager">Manager</option>
                           </select>
                           <select name="managerId" class="w-full p-2 mb-4 border rounded">
                                <option value="">Select Manager (for Employee)</option>
                                ${managers.map(m => `<option value="${m.id}">${m.name || m.email}</option>`).join('')}
                           </select>
                           <div class="flex justify-end">
                                <button type="button" id="cancel-add-user" class="px-4 py-2 bg-gray-300 rounded-md mr-2">Cancel</button>
                                <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md">Add User</button>
                           </div>
                        </form>
                    </div>
                </div>


                <div class="mt-8 bg-white p-6 rounded-lg shadow-md">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Manager</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${companyUsers.map(user => `
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap">${user.name || user.email}</td>
                                    <td class="px-6 py-4 whitespace-nowrap">${user.role}</td>
                                    <td class="px-6 py-4 whitespace-nowrap">${(db.users.find(m => m.id === user.managerId) || {}).name || 'N/A'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        };

        const addAdminEventListeners = () => {
             if (document.getElementById('add-user-btn')) {
                const modal = document.getElementById('add-user-modal');
                document.getElementById('add-user-btn').addEventListener('click', () => modal.classList.remove('hidden'));
                document.getElementById('cancel-add-user').addEventListener('click', () => modal.classList.add('hidden'));
                
                document.getElementById('add-user-form').addEventListener('submit', e => {
                    e.preventDefault();
                    const newUser = {
                        id: 'user_' + Date.now(),
                        companyId: db.currentUser.companyId,
                        name: e.target.name.value,
                        email: e.target.email.value,
                        password: e.target.password.value,
                        role: e.target.role.value,
                        managerId: e.target.managerId.value || null,
                    };
                    db.users.push(newUser);
                    db.save();
                    modal.classList.add('hidden');
                    router(); // Re-render the page
                });
             }
        };
        
        const getApprovalRulesContent = () => {
            return `<h3 class="text-3xl font-medium text-gray-700">Approval Rules (Feature coming soon)</h3>`;
        };
        
        // --- MANAGER DASHBOARD ---
        const renderManagerDashboard = (route, param) => {
            const sidebarLinks = `
                <a href="#dashboard" class="sidebar-link ${route === 'dashboard' ? 'active' : ''} flex items-center px-4 py-2 text-gray-700 hover:bg-gray-200">
                    <i data-lucide="layout-dashboard" class="w-5 h-5 mr-2"></i> Dashboard
                </a>
                <a href="#team-expenses" class="sidebar-link ${route === 'team-expenses' ? 'active' : ''} flex items-center px-4 py-2 text-gray-700 hover:bg-gray-200">
                    <i data-lucide="users" class="w-5 h-5 mr-2"></i> Team Expenses
                </a>
                <a href="#my-expenses" class="sidebar-link ${route === 'my-expenses' ? 'active' : ''} flex items-center px-4 py-2 text-gray-700 hover:bg-gray-200">
                    <i data-lucide="receipt" class="w-5 h-5 mr-2"></i> My Expenses
                </a>
            `;
             let content = '';
            switch(route) {
                case 'dashboard': content = getManagerDashboardContent(); break;
                case 'team-expenses': content = getTeamExpensesContent(); break;
                case 'my-expenses': content = getEmployeeExpensesContent(); break; // Manager is also an employee
                default: content = getManagerDashboardContent();
            }

            app.innerHTML = renderLayout(sidebarLinks, content);
            lucide.createIcons();
            addManagerEventListeners();
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
        };
        
        const getManagerDashboardContent = () => {
            const teamMemberIds = db.users.filter(u => u.managerId === db.currentUser.id).map(u => u.id);
            const teamExpenses = db.expenses.filter(e => teamMemberIds.includes(e.userId));
            const pendingApproval = teamExpenses.filter(e => e.status === 'Pending' && e.approvers[e.currentApproverIndex]?.approverId === db.currentUser.id).length;
            
            const myExpenses = db.expenses.filter(e => e.userId === db.currentUser.id);
            const myPending = myExpenses.filter(e => e.status === 'Pending').length;
            const myApproved = myExpenses.filter(e => e.status === 'Approved').length;
            const myRejected = myExpenses.filter(e => e.status === 'Rejected').length;


            return `
                 <h3 class="text-3xl font-medium text-gray-700">Manager Dashboard</h3>
                 <div class="mt-4">
                    <h4 class="text-xl font-medium text-gray-700 mb-2">Team Overview</h4>
                     <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h4 class="text-gray-600 text-sm font-medium">Awaiting My Approval</h4>
                            <p class="text-3xl font-bold text-yellow-500">${pendingApproval}</p>
                        </div>
                     </div>
                 </div>
                 <div class="mt-8">
                    <h4 class="text-xl font-medium text-gray-700 mb-2">My Expenses Overview</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h4 class="text-gray-600 text-sm font-medium">My Pending</h4>
                            <p class="text-3xl font-bold text-yellow-500">${myPending}</p>
                        </div>
                         <div class="bg-white p-6 rounded-lg shadow-md">
                            <h4 class="text-gray-600 text-sm font-medium">My Approved</h4>
                            <p class="text-3xl font-bold text-green-500">${myApproved}</p>
                        </div>
                         <div class="bg-white p-6 rounded-lg shadow-md">
                            <h4 class="text-gray-600 text-sm font-medium">My Rejected</h4>
                            <p class="text-3xl font-bold text-red-500">${myRejected}</p>
                        </div>
                    </div>
                 </div>
            `;
        };
        
        const getTeamExpensesContent = () => {
            const teamMemberIds = db.users.filter(u => u.managerId === db.currentUser.id).map(u => u.id);
            const teamExpenses = db.expenses.filter(e => teamMemberIds.includes(e.userId) && e.status === 'Pending');
            const expensesForMyApproval = teamExpenses.filter(e => e.approvers[e.currentApproverIndex]?.approverId === db.currentUser.id);

            return `
                 <h3 class="text-3xl font-medium text-gray-700">Team Expenses for Approval</h3>
                 <div class="mt-8 bg-white p-6 rounded-lg shadow-md">
                    ${expensesForMyApproval.length === 0 ? '<p>No expenses require your approval at this time.</p>' : `
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Employee</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                          ${expensesForMyApproval.map(expense => `
                             <tr>
                                <td class="px-6 py-4 whitespace-nowrap">${(db.users.find(u => u.id === expense.userId) || {}).name}</td>
                                <td class="px-6 py-4 whitespace-nowrap">${expense.date}</td>
                                <td class="px-6 py-4 whitespace-nowrap">${expense.category}</td>
                                <td class="px-6 py-4 whitespace-nowrap">${expense.amount.toFixed(2)} ${expense.currency}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <button class="approve-expense-btn text-green-600 hover:text-green-900 mr-4" data-id="${expense.id}">Approve</button>
                                    <button class="reject-expense-btn text-red-600 hover:text-red-900" data-id="${expense.id}">Reject</button>
                                </td>
                            </tr>
                          `).join('')}
                        </tbody>
                    </table>`}
                </div>
            `;
        };

        const addManagerEventListeners = () => {
            document.querySelectorAll('.approve-expense-btn').forEach(btn => {
                btn.addEventListener('click', e => {
                    const expenseId = e.target.dataset.id;
                    handleExpenseApproval(expenseId, 'Approved');
                });
            });
            document.querySelectorAll('.reject-expense-btn').forEach(btn => {
                btn.addEventListener('click', e => {
                    const expenseId = e.target.dataset.id;
                    const comment = prompt("Please provide a reason for rejection:");
                    if (comment) {
                         handleExpenseApproval(expenseId, 'Rejected', comment);
                    }
                });
            });
        };
        
        // --- EMPLOYEE DASHBOARD ---
        const renderEmployeeDashboard = (route, param) => {
            const sidebarLinks = `
                <a href="#dashboard" class="sidebar-link ${route === 'dashboard' ? 'active' : ''} flex items-center px-4 py-2 text-gray-700 hover:bg-gray-200">
                    <i data-lucide="layout-dashboard" class="w-5 h-5 mr-2"></i> Dashboard
                </a>
                <a href="#expenses" class="sidebar-link ${route === 'expenses' ? 'active' : ''} flex items-center px-4 py-2 text-gray-700 hover:bg-gray-200">
                    <i data-lucide="receipt" class="w-5 h-5 mr-2"></i> My Expenses
                </a>
            `;
            let content = '';
            switch(route) {
                case 'dashboard': content = getEmployeeDashboardContent(); break;
                case 'expenses': content = getEmployeeExpensesContent(); break;
                default: content = getEmployeeDashboardContent();
            }

            app.innerHTML = renderLayout(sidebarLinks, content);
            lucide.createIcons();
            addEmployeeEventListeners();
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
        };
        
        const getEmployeeDashboardContent = () => {
            const myExpenses = db.expenses.filter(e => e.userId === db.currentUser.id);
            const pending = myExpenses.filter(e => e.status === 'Pending').length;
            const approved = myExpenses.filter(e => e.status === 'Approved').length;
            const rejected = myExpenses.filter(e => e.status === 'Rejected').length;
            const total = myExpenses.reduce((sum, e) => sum + e.amount, 0);
            
            return `
                 <h3 class="text-3xl font-medium text-gray-700">Employee Dashboard</h3>
                 <div class="mt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h4 class="text-gray-600 text-sm font-medium">Total Submitted</h4>
                        <p class="text-3xl font-bold text-gray-800">${myExpenses.length}</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h4 class="text-gray-600 text-sm font-medium">Pending</h4>
                        <p class="text-3xl font-bold text-yellow-500">${pending}</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h4 class="text-gray-600 text-sm font-medium">Approved</h4>
                        <p class="text-3xl font-bold text-green-500">${approved}</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h4 class="text-gray-600 text-sm font-medium">Rejected</h4>
                        <p class="text-3xl font-bold text-red-500">${rejected}</p>
                    </div>
                </div>
            `;
        };
        
        const getEmployeeExpensesContent = () => {
            const myExpenses = db.expenses.filter(e => e.userId === db.currentUser.id);

            return `
                <div class="flex justify-between items-center">
                    <h3 class="text-3xl font-medium text-gray-700">My Expenses</h3>
                    <button id="add-expense-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Add Expense</button>
                </div>
                 <!-- Add expense modal -->
                <div id="add-expense-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
                    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Add New Expense</h3>
                        <form id="add-expense-form">
                           <input name="date" type="date" required class="w-full p-2 mb-4 border rounded">
                           <input name="category" type="text" required class="w-full p-2 mb-4 border rounded" placeholder="Category (e.g., Travel, Food)">
                           <textarea name="description" required class="w-full p-2 mb-4 border rounded" placeholder="Description"></textarea>
                           <input name="amount" type="number" step="0.01" required class="w-full p-2 mb-4 border rounded" placeholder="Amount">
                           <input name="currency" type="text" required class="w-full p-2 mb-4 border rounded" placeholder="Currency (e.g., USD, INR)">
                           <label class="block mb-2 text-sm font-medium text-gray-900">Receipt (optional)</label>
                           <input name="receipt" type="file" class="w-full p-2 mb-4 border rounded">
                           <div class="flex justify-end">
                                <button type="button" id="cancel-add-expense" class="px-4 py-2 bg-gray-300 rounded-md mr-2">Cancel</button>
                                <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md">Submit</button>
                           </div>
                        </form>
                    </div>
                </div>

                <div class="mt-8 bg-white p-6 rounded-lg shadow-md">
                     ${getExpensesTable(myExpenses)}
                </div>
            `;
        };

        const addEmployeeEventListeners = () => {
             if (document.getElementById('add-expense-btn')) {
                const modal = document.getElementById('add-expense-modal');
                document.getElementById('add-expense-btn').addEventListener('click', () => modal.classList.remove('hidden'));
                document.getElementById('cancel-add-expense').addEventListener('click', () => modal.classList.add('hidden'));
                
                document.getElementById('add-expense-form').addEventListener('submit', e => {
                    e.preventDefault();
                    
                    const user = db.currentUser;
                    const manager = db.users.find(u => u.id === user.managerId);
                    
                    if (!manager) {
                        alert("You don't have a manager assigned. Cannot submit expense.");
                        return;
                    }

                    // Simple approval flow: manager first
                    const approvers = [{ approverId: manager.id, status: 'Pending' }];
                    
                    const newExpense = {
                        id: 'exp_' + Date.now(),
                        userId: db.currentUser.id,
                        date: e.target.date.value,
                        category: e.target.category.value,
                        description: e.target.description.value,
                        amount: parseFloat(e.target.amount.value),
                        currency: e.target.currency.value.toUpperCase(),
                        status: 'Pending',
                        approvers: approvers,
                        currentApproverIndex: 0,
                        comments: []
                    };
                    db.expenses.push(newExpense);
                    db.save();
                    modal.classList.add('hidden');
                    router(); // Re-render the page
                });
            }
        };

        // --- SHARED COMPONENTS ---
        const getAllExpensesContent = (role) => {
             const companyExpenses = db.expenses.filter(e => {
                const user = db.users.find(u => u.id === e.userId);
                return user && user.companyId === db.currentUser.companyId;
            });
            return `
                <h3 class="text-3xl font-medium text-gray-700">All Company Expenses</h3>
                <div class="mt-8 bg-white p-6 rounded-lg shadow-md">
                     ${getExpensesTable(companyExpenses, true)}
                </div>
            `;
        };
        
        const getExpensesTable = (expenses, showEmployee = false) => {
            if (expenses.length === 0) return '<p>No expenses found.</p>';
            return `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            ${showEmployee ? '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Employee</th>' : ''}
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Current Approver</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${expenses.map(expense => {
                            const statusColor = {
                                'Pending': 'bg-yellow-100 text-yellow-800',
                                'Approved': 'bg-green-100 text-green-800',
                                'Rejected': 'bg-red-100 text-red-800',
                            }[expense.status];

                            let currentApproverName = 'N/A';
                            if(expense.status === 'Pending') {
                                const currentApprover = db.users.find(u => u.id === expense.approvers[expense.currentApproverIndex]?.approverId);
                                currentApproverName = currentApprover?.name || 'Pending';
                            } else if (expense.status === 'Approved') {
                                currentApproverName = 'Fully Approved';
                            } else if (expense.status === 'Rejected') {
                                currentApproverName = 'Rejected';
                            }


                            return `
                            <tr>
                                ${showEmployee ? `<td class="px-6 py-4 whitespace-nowrap">${(db.users.find(u => u.id === expense.userId) || {}).name}</td>` : ''}
                                <td class="px-6 py-4 whitespace-nowrap">${expense.date}</td>
                                <td class="px-6 py-4 whitespace-nowrap">${expense.category}</td>
                                <td class="px-6 py-4 whitespace-nowrap">${expense.amount.toFixed(2)} ${expense.currency}</td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">
                                        ${expense.status}
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">${currentApproverName}</td>
                            </tr>`
                        }).join('')}
                    </tbody>
                </table>
            `;
        };

        // --- BUSINESS LOGIC ---
        const handleExpenseApproval = (expenseId, newStatus, comment = '') => {
            const expense = db.expenses.find(e => e.id === expenseId);
            if (!expense) return;

            // Log current approver's action
            const currentApproverInfo = expense.approvers[expense.currentApproverIndex];
            currentApproverInfo.status = newStatus;
            currentApproverInfo.date = new Date().toISOString().split('T')[0];
            if(comment) {
                expense.comments.push({
                    user: db.currentUser.name,
                    comment: comment,
                    date: new Date().toISOString()
                });
            }


            if (newStatus === 'Rejected') {
                expense.status = 'Rejected';
            } else if (newStatus === 'Approved') {
                // Check if there is a next approver
                if (expense.currentApproverIndex < expense.approvers.length - 1) {
                    expense.currentApproverIndex++;
                    // Status of the expense remains 'Pending'
                } else {
                    // This was the last approver
                    expense.status = 'Approved';
                }
            }

            db.save();
            router();
        };

        // --- APP INITIALIZATION ---
        window.addEventListener('hashchange', router);
        window.addEventListener('load', router);

    </script>
</body>
</html>